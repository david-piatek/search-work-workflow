# Job Scraper Application - Documentation Projet

## Vue d'ensemble

Job search workflow automation platform with multiple applications:

### Applications

1. **Job Scraper** - Job offers scraping application
   - Frontend: Vite + Svelte
   - Backend: NestJS + TypeORM + Bull Queue
   - Features: Dynamic scraper generation, job search automation

2. **Letter Generator** - CLI tool for generating personalized cover letters
   - Technology: Node.js + Puppeteer
   - Features: HTML template hydration, PDF generation, CSS styling
   - Input: JSON data file + HTML template
   - Output: Professional styled PDF letters
   - Supports: QR codes, images, custom fonts, CSS styling

3. **QR Code Generator** - Service for generating QR codes
   - Technology: Node.js + qrcode library
   - Features: PNG/SVG generation, customizable colors, batch processing
   - Integration: Works with Letter Generator for inline QR codes
   - Supports: Data URLs, file output, elegant styling preset

4. **Static Site Generator** - G√©n√©rateur de sites de pr√©sentation
   - Technology: Node.js + HTML/CSS
   - Features: Sites √©l√©gants g√©n√©r√©s depuis JSON, responsive design
   - Sections: D√©marche, workflow, matching, CV iframe, stats
   - Deployment: GitHub Pages, Netlify, Vercel ready

5. **Application Workflow** - Workflow complet de candidature
   - Technology: NestJS + TypeORM + Puppeteer
   - Features: Orchestration compl√®te g√©n√©ration de candidature
   - Workflow: Site HTML ‚Üí Site PDF ‚Üí QR Code ‚Üí Lettre PDF avec QR
   - Backend-orchestrated avec polling frontend
   - Self-hosted sites via endpoint d√©di√©
   - Progress tracking en temps r√©el

### Infrastructure
- Docker & Kubernetes for containerization
- Helm charts for deployment
- ArgoCD for GitOps
- n8n for workflow automation

## Architecture

### Backend (NestJS)

**Modules:**
- `scrapers`: Gestion et g√©n√©ration dynamique de scrapers
- `jobs`: Stockage et r√©cup√©ration des offres scrap√©es
- `generators`: Services de g√©n√©ration (Site, QR, Letter)
- `workflow`: Orchestration compl√®te du workflow de candidature
- `hosting`: Service de sites statiques self-hosted

**Services cl√©s:**
- `ScraperGeneratorService`: G√©n√®re le code des scrapers automatiquement
- `ScraperExecutorService`: Ex√©cute les scrapers et sauvegarde les r√©sultats
- `ScraperProcessor`: Traite les jobs de scraping via Bull Queue
- `WorkflowService`: Orchestre le workflow complet de candidature (Site ‚Üí QR ‚Üí Letter)
- `SiteService`: G√©n√©ration de sites statiques (HTML + PDF)
- `QrService`: G√©n√©ration de QR codes avec styles personnalis√©s
- `LetterService`: G√©n√©ration de lettres PDF avec QR codes int√©gr√©s
- `HostingService`: Service de sites statiques self-hosted

**Technologies:**
- TypeORM pour PostgreSQL
- Bull pour les queues Redis
- Puppeteer + Cheerio pour le scraping
- Swagger pour la documentation API

### Frontend (Svelte)

**Composants principaux:**
- `ScraperSelector`: S√©lection et cr√©ation de scrapers
- `JobsList`: Affichage des r√©sultats scrap√©s
- `Stats`: Dashboard de statistiques

**Features:**
- API client avec Axios
- Storybook pour documentation composants
- Tests E2E avec Playwright

### Infrastructure

**Docker Compose:**
- PostgreSQL 16
- Redis 7
- Backend NestJS
- Frontend Svelte/Nginx

**Kubernetes (Helm):**
- Deployments: backend, frontend
- StatefulSets: postgres, redis
- Services, Ingress, PVC
- HPA (optionnel)

**ArgoCD:**
- GitOps pour d√©ploiement automatique
- Sync automatique des changements
- Health checks et rollbacks

### Workflow n8n

Pipeline automatis√©:
1. Schedule (cron toutes les 6h)
2. R√©cup√©ration des scrapers
3. Ex√©cution s√©quentielle
4. Sauvegarde JSON locale
5. Backup GitHub dans `/backup`
6. Notification Slack

## Standards Appliqu√©s

### Structure Monorepo

```
apps/
  backend/              # NestJS API (job scraper)
  frontend/             # Svelte SPA (job scraper UI)
  letter-generator/     # CLI tool for PDF letter generation
    src/                # Source code
      index.js          # Standard generator
      index-qr.js       # Generator with QR service integration
      qr-service.js     # QR code service wrapper
    templates/          # Letter templates
    output/             # Generated PDFs
    test/               # Tests
  qr-generator/         # QR code generation service
    src/                # Source code
      index.js          # CLI
      generator.js      # QR generation logic
    output/             # Generated QR codes
    test/               # Tests
  static-site/          # Static site generator
    src/                # Source code
      index.js          # Generator CLI
    templates/          # HTML templates
      presentation.html # Main template
      synthwave.html    # Synthwave template
    data/               # JSON data files
    output/             # Generated sites
    assets/             # Images, CSS
hosted-sites/           # Self-hosted static sites (served by backend)
cloud/
  docker/               # Docker Compose and Dockerfiles
    Dockerfile.backend
    Dockerfile.frontend
    Dockerfile.letter-generator
    Dockerfile.qr-generator
  helm/                 # Kubernetes charts
  argocd/               # GitOps config
n8n/                    # Workflow automation
  template-lettre.txt   # Letter template
```

### Docker

- Multi-stage builds pour optimisation
- Images Alpine pour l√©g√®ret√©
- Health checks configur√©s
- Volumes pour persistence
- Utilisation de `docker compose` (v2) au lieu de `docker-compose`
- Centralisation dans `cloud/docker/`

### Helm Charts

- Templates modulaires
- Values pour diff√©rents environnements
- Secrets management
- Resource limits/requests
- Probes (liveness/readiness)

### Taskfile

Commandes standardis√©es:
- `dev`: D√©veloppement
- `build`: Build production
- `test`: Tests (unit + e2e)
- `lint`: Linting
- `docker:*`: Gestion Docker
- `helm:*`: D√©ploiement K8s

### Tests

**Backend:**
- Tests unitaires: Jest
- Tests e2e: Supertest
- Coverage configur√©

**Frontend:**
- Tests unitaires: Vitest
- Tests e2e: Playwright
- Tests composants: Storybook

### Git Hooks

- **pre-commit**: lint-staged
  - Prettier
  - ESLint

- **pre-push**:
  - Tous les tests

### Outils d'Analyse

- **Swagger**: Documentation API auto-g√©n√©r√©e
- **Storybook**: Catalogue de composants UI
- **TypeScript**: Typage strict
- **ESLint + Prettier**: Code quality

## Fonctionnement

### G√©n√©ration Dynamique de Scrapers

1. Frontend envoie nom + URL du site
2. Backend v√©rifie si scraper existe en DB
3. Si non, `ScraperGeneratorService` g√©n√®re le code
4. Code g√©n√©rique avec s√©lecteurs CSS communs
5. Sauvegarde en DB avec metadata
6. Retour du scraper au frontend

### Ex√©cution de Scraping

1. Frontend demande ex√©cution
2. Backend ajoute job √† la queue Redis
3. `ScraperProcessor` r√©cup√®re le job
4. Ex√©cution du code scraper (Puppeteer)
5. Parsing HTML avec Cheerio
6. Sauvegarde JSON + PostgreSQL
7. Mise √† jour stats d'ex√©cution

### D√©ploiement GitOps

1. Push vers GitHub
2. ArgoCD d√©tecte changement
3. Sync automatique Helm chart
4. Rollout K8s progressif
5. Health checks
6. Rollback automatique si erreur

### Workflow n8n

1. Trigger schedule (cron)
2. GET `/scrapers` ‚Üí liste
3. Pour chaque scraper:
   - POST `/scrapers/execute`
   - Wait 30s
   - GET `/jobs?source={scraper}`
4. Save JSON local + GitHub
5. Notification Slack

## Configuration Environnements

### D√©veloppement

```bash
# Lancer tous les services de d√©veloppement
task dev

# Frontend: http://localhost:5174 (Svelte + Vite)
# Backend: http://localhost:3001 (NestJS)
# Swagger: http://localhost:3001/api

# Ou lancer individuellement
task dev:frontend  # Frontend seul
task dev:backend   # Backend seul
```

**Pr√©requis d√©veloppement local:**
- Cr√©er un fichier `.env` dans `apps/backend/` bas√© sur `.env.example`
- Port backend configurable via variable `PORT` (d√©faut: 3001 pour √©viter conflits)
- Services Docker requis: PostgreSQL (port 5432), Redis (port 6379)

**Configuration Backend (.env):**
```env
NODE_ENV=development
PORT=3001
DATABASE_URL=postgresql://admin:admin123@localhost:5432/jobscraper
REDIS_URL=redis://localhost:6379
DATA_DIR=./data
```

**D√©marrage services infrastructure:**
```bash
# D√©marrer PostgreSQL et Redis
docker compose -f cloud/docker/compose.yaml up postgres redis -d

# V√©rifier que les services sont up et healthy
docker ps | grep job-scraper
```

### Docker Local

```bash
task docker:up
# Avec PostgreSQL + Redis + Backend + Frontend
```

### Production K8s

```bash
# Via Helm
task helm:install

# Via ArgoCD (GitOps)
kubectl apply -f argocd/application.yaml
```

## Points d'Attention

### S√©curit√©

- Secrets en K8s Secrets (pas en values.yaml plain)
- CORS configur√© sur backend
- Validation des inputs (class-validator)
- Rate limiting recommand√© (production)

### Performance

- Bull Queue pour async processing
- Redis cache
- Index DB sur colonnes fr√©quentes
- HPA pour scaling automatique

### Monitoring

- Logs structur√©s (JSON)
- Health endpoints (`/api`)
- Prometheus metrics (√† ajouter)
- Grafana dashboards (√† ajouter)

### Backup

- Donn√©es jobs en PostgreSQL
- Fichiers JSON en PVC K8s
- Backup GitHub via n8n
- Snapshots DB recommand√©s

## Prochaines √âtapes

1. Ajouter plus de scrapers pr√©d√©finis
2. Am√©liorer g√©n√©ration automatique (IA)
3. Impl√©menter authentification API
4. Ajouter m√©triques Prometheus
5. CI/CD pipeline (GitHub Actions)
6. Documentation utilisateur d√©taill√©e
7. Tests de charge
8. Monitoring avanc√© (Datadog/New Relic)

## Commandes Utiles

```bash
# Dev
task dev

# Tests
task test
task test:letter

# Build
task build

# Docker
task docker:build
task docker:up

# Letter Generator
task letter:generate                    # Generate with example data
task letter:generate:elegant            # Generate elegant Christmas letter
task letter:generate:qr                 # Generate with local QR code
task letter:generate:custom \           # Generate with custom data
  TEMPLATE=path/to/template.txt \
  DATA=path/to/data.json \
  OUTPUT=path/to/output.pdf
task letter:docker:build                # Build Docker image
task letter:docker:run                  # Run in Docker

# QR Code Generator
task qr:generate URL="https://example.com"     # Generate QR code
task qr:generate:elegant URL="https://..."     # Generate elegant QR code
task qr:docker:build                           # Build Docker image
task qr:docker:run URL="https://..."           # Run in Docker

# Static Site Generator
task site:generate                             # Generate presentation site
task site:generate:custom DATA=data/file.json  # Generate with custom data
task site:serve                                # Serve locally
task site:open                                 # Open in browser

# K8s
task helm:install
kubectl get pods -n job-scraper

# Logs
task docker:logs
kubectl logs -n job-scraper -l app=backend -f

# Storybook
task storybook

# Swagger
open http://localhost:3000/api
```

## Technologies Compl√®tes

**Frontend:**
- Svelte 4
- Vite 5
- Axios
- Storybook 7
- Playwright
- Vitest

**Backend:**
- NestJS 10
- TypeORM
- Bull
- Puppeteer
- Cheerio
- Swagger
- Jest

**Infrastructure:**
- Docker & Docker Compose
- Kubernetes
- Helm 3
- ArgoCD
- n8n
- PostgreSQL 16
- Redis 7

**DevOps:**
- Task (go-task)
- Husky
- lint-staged
- Prettier
- ESLint

## Organisation Cloud

L'ensemble des ressources cloud est centralis√© dans le r√©pertoire `cloud/`:

- **`cloud/docker/`**:
  - `compose.yaml` (v2 naming convention)
  - `Dockerfile.backend`
  - `Dockerfile.frontend`

- **`cloud/helm/`**:
  - Charts Kubernetes pour d√©ploiement

- **`cloud/argocd/`**:
  - Configuration GitOps

### Conventions

- Utiliser `docker compose` (v2) au lieu de `docker-compose` (v1)
- Fichier nomm√© `compose.yaml` (convention moderne) au lieu de `docker-compose.yml`
- Paths relatifs depuis la racine du projet
- Centralisation cloud pour faciliter la maintenance

## CI/CD

### GitHub Actions (CI)

Pipeline de Continuous Integration sur GitHub:
- **Lint**: ESLint et Prettier sur backend et frontend
- **Tests Backend**: Tests unitaires et e2e avec PostgreSQL/Redis
- **Tests Frontend**: Tests unitaires et e2e
- **Build**: Build de production backend et frontend
- **Docker Build**: Validation des images Docker
- **Trigger GitLab**: D√©clenche le CD GitLab si CI passe

### GitLab CI/CD (CD)

Pipeline de Continuous Deployment sur GitLab:
- **Build**: Construction et push des images Docker au registry
- **Deploy Staging**: D√©ploiement auto sur branche `develop`
- **Deploy Production**: D√©ploiement manuel sur branche `main`
- **Verify**: Health checks post-d√©ploiement

### Workflow

1. Push sur GitHub ‚Üí CI s'ex√©cute
2. CI passe ‚Üí Trigger GitLab CD
3. GitLab build les images Docker
4. GitLab d√©ploie sur Kubernetes
5. Verification du d√©ploiement

### Configuration Requise

**GitHub Secrets:**
- `GITLAB_TRIGGER_TOKEN`
- `GITLAB_TRIGGER_URL`

**GitLab Variables:**
- `CI_REGISTRY`, `CI_REGISTRY_USER`, `CI_REGISTRY_PASSWORD`
- `KUBE_CONFIG_STAGING`, `KUBE_CONFIG_PROD`

Voir `SETUP_CI_CD.md` pour la configuration compl√®te.

## Letter Generator Usage

### Templates Disponibles

#### 1. Template Standard (`letter-template.html`)
Template professionnel basique et √©pur√©.

```bash
task letter:generate
```

#### 2. Template √âl√©gant de No√´l (`letter-christmas-elegant.html`)
Template premium avec design festif sophistiqu√© :
- ‚úçÔ∏è Polices manuscrites √©l√©gantes (Cormorant Garamond, Playfair Display, Great Vibes)
- üé® Palette de couleurs raffin√©e (bordeaux, or, cr√®me)
- üéÑ Ornements festifs subtils et professionnels
- üìê Typographie soign√©e et mise en page √©l√©gante
- üåü Signature manuscrite stylis√©e

**Usage:**
```bash
task letter:generate:elegant
```

**Parfait pour:**
- Candidatures de fin d'ann√©e
- Communications premium
- Networking p√©riode de f√™tes
- Lettres de motivation executives

### G√©n√©ration Rapide

```bash
# Template standard
task letter:generate

# Template √©l√©gant No√´l
task letter:generate:elegant

# Template personnalis√©
task letter:generate:custom \
  TEMPLATE=path/to/template.html \
  DATA=path/to/data.json \
  OUTPUT=path/to/output.pdf
```

### Docker Usage

```bash
# Build image
task letter:docker:build

# Generate letter
task letter:docker:run
```

### Variables Template Standard

```json
{
  "Date": "4 d√©cembre 2025",
  "matching-description": "Description...",
  "qr-code": "<img src='URL'>",
  "cv-link": "<a href='URL'>Texte</a>",
  "contact-info": "contact@example.com"
}
```

### Variables Template √âl√©gant

```json
{
  "sender-name": "Nom Pr√©nom",
  "sender-address": "Adresse",
  "sender-city": "Ville Code Postal",
  "Date": "Date",
  "subject": "Objet de la lettre",
  "greeting": "Madame, Monsieur",
  "intro-paragraph": "Premier paragraphe...",
  "second-paragraph": "Deuxi√®me paragraphe...",
  "matching-description": "Ce qui vous a interpell√©...",
  "closing-paragraph": "Paragraphe de conclusion...",
  "wishes": "V≈ìux de fin d'ann√©e...",
  "closing-formula": "Formule de politesse",
  "signature-text": "Signature",
  "qr-code": "<img src='QR code URL'>",
  "cv-link": "<a href='URL'>Lien portfolio</a>",
  "contact-info": "Informations de contact compl√®tes"
}
```

### Typographie Template √âl√©gant

**Polices Google Fonts:**
- **Cormorant Garamond**: Corps de texte (serif √©l√©gant)
- **Playfair Display**: Titres et emphase
- **Great Vibes**: Signature (manuscrit script)

**Palette de Couleurs:**
- Texte principal: `#2c3e50` (bleu-gris fonc√©)
- Accent or: `#8b6f47` (bronze chaud)
- Accent bordeaux: `#a07855` (brun-or √©l√©gant)
- Fond: `#fdfbf7` (cr√®me chaud)
- Bordures: `#e8dcc8` (beige doux)

### Personnalisation Templates

Templates = fichiers HTML avec :
- Support CSS3 complet
- Int√©gration Google Fonts
- Styles print-optimized (`@page`, `@media print`)
- Variables: `{{variable-name}}`
- Support images/QR codes
- HTML dans les donn√©es JSON possible

## QR Code Generator Usage

### G√©n√©ration Simple

```bash
# QR code standard
task qr:generate URL="https://github.com/davidpiatek"

# QR code √©l√©gant (couleurs template)
task qr:generate:elegant URL="https://github.com/davidpiatek"
```

### CLI Direct

```bash
cd apps/qr-generator

# PNG standard
node src/index.js generate \
  -d "https://example.com" \
  -o output/qr.png \
  --width 300 \
  --dark "#000000" \
  --light "#FFFFFF"

# Style √©l√©gant
node src/index.js elegant \
  -d "https://example.com" \
  -o output/elegant-qr.png

# Data URL (base64 inline)
node src/index.js data-url \
  -d "https://example.com" \
  --width 200

# Batch generation
node src/index.js batch -i batch-config.json
```

### Int√©gration avec Letter Generator

**M√©thode 1: Utiliser qr-code-url dans JSON**

```json
{
  "qr-code-url": "https://github.com/davidpiatek",
  "cv-link": "https://github.com/davidpiatek"
}
```

Puis g√©n√©rer avec:
```bash
task letter:generate:qr
```

Le QR code sera automatiquement g√©n√©r√© en inline (base64) dans le PDF.

**M√©thode 2: API Programmatique**

```javascript
import { QRCodeService } from './src/qr-service.js';

const qrService = new QRCodeService();

// G√©n√©rer HTML inline
const html = await qrService.generateInlineHTML('https://example.com');

// G√©n√©rer style √©l√©gant
const elegantHTML = await qrService.generateElegantHTML('https://example.com');

// Traiter donn√©es template automatiquement
const data = { 'qr-code-url': 'https://...' };
const processed = await qrService.processTemplateData(data, true);
```

### Options de G√©n√©ration

**Formats support√©s:**
- PNG (d√©faut)
- SVG (vectoriel)
- Data URL (base64 inline)

**Niveaux de correction d'erreur:**
- L: ~7% r√©cup√©ration
- M: ~15% r√©cup√©ration
- Q: ~25% r√©cup√©ration
- H: ~30% r√©cup√©ration (recommand√©)

**Couleurs pr√©d√©finies:**
- Standard: noir/blanc
- √âl√©gant: `#2c3e50` / `#fdfbf7` (template Christmas)

### Docker Usage

```bash
# Build
task qr:docker:build

# Generate
task qr:docker:run URL="https://example.com"

# Ou directement
docker run --rm -v $(pwd)/output:/app/output qr-generator \
  elegant -d "https://example.com" -o /app/output/qr.png
```

## R√©solution de Probl√®mes

### Letter Generator - "socket hang up" Error

**Probl√®me:** Erreur "socket hang up" lors de la g√©n√©ration de PDF.

**Cause:**
- Chromium browser non install√© ou version incorrecte pour Puppeteer
- Versions obsol√®tes de Puppeteer (< 24.x) ne sont plus support√©es

**Solution:**
1. Mettre √† jour Puppeteer vers version 24+ dans `package.json`:
   ```json
   "puppeteer": "^24.2.0"
   ```

2. Installer le navigateur Chrome correct:
   ```bash
   cd apps/letter-generator
   npm install
   npx puppeteer browsers install chrome
   ```

3. V√©rifier l'installation:
   ```bash
   ls ~/.cache/puppeteer/chrome/
   ```

**Configuration Puppeteer:**
- Browser install√© dans: `~/.cache/puppeteer/`
- Version Chrome requise: 143.0.7499.40 (pour Puppeteer 24.x)
- Arguments de lancement optimis√©s pour macOS ARM64
- Gestion des ressources externes avec timeout et error handling

## Static Site Generator Usage

### G√©n√©ration Rapide

```bash
# G√©n√©rer le site de pr√©sentation
task site:generate

# Ouvrir dans le navigateur
task site:open

# Servir localement avec hot reload
task site:serve
```

### Structure du Site G√©n√©r√©

Le site contient :
- **Header avec H1 personnalis√©** (depuis JSON)
- **Section "Ma D√©marche"** avec explication d√©taill√©e
- **Workflow avec screenshot** + √©tapes d√©taill√©es
- **Matching avec l'entreprise** (points personnalis√©s)
- **Statistiques** en chiffres
- **CV int√©gr√©** via iframe
- **Footer** avec liens sociaux

### Personnalisation JSON

```json
{
  "main-title": "Votre titre H1 ici",
  "company-name": "Nom de l'entreprise",
  "workflow-image": "URL ou chemin vers screenshot",
  "workflow-steps": [...],
  "matching-points": [...],
  "cv-url": "https://votre-cv.com"
}
```

### Workflow Complet

```bash
# 1. G√©n√©rer site de pr√©sentation
task site:generate

# 2. D√©ployer sur Netlify/Vercel
cd apps/static-site/output && netlify deploy

# 3. G√©n√©rer QR code vers le site
task qr:generate:elegant URL="https://votre-site.com"

# 4. G√©n√©rer lettre avec QR code
task letter:generate:qr

# R√©sultat : Lettre √©l√©gante + QR code ‚Üí Site de pr√©sentation complet
```

### Sections Personnalisables

**Ma D√©marche:**
- Expliquez votre approche automatis√©e
- Support HTML pour formatage riche

**Workflow:**
- Screenshot/diagramme du workflow
- √âtapes num√©rot√©es avec descriptions

**Matching:**
- 4 points cl√©s de matching avec ic√¥nes
- Personnalis√© par entreprise

**Stats:**
- Chiffres cl√©s (exp√©rience, projets, etc.)
- Grid responsive automatique

**CV:**
- iframe vers CV en ligne
- Lien externe pour nouvel onglet

## Static Site - Style Synthwave

### Nouveau Template R√©tro-Futuriste

**Style synthwave** avec :
- üé® Couleurs n√©on adoucies (rose/cyan/violet)
- üåä Grille 3D anim√©e en fond
- ‚ú® Effets glow subtils
- üì± Design responsive
- ‚ö° Ultra performant

### Gestion Dynamique par URL

```bash
# Sans param√®tre ‚Üí Landing page (pas de matching)
https://search-work.draw-me-the-moon.fr

# Avec param√®tre ‚Üí Page personnalis√©e avec matching
https://search-work.draw-me-the-moon.fr?company=Hones
```

Le JavaScript d√©tecte automatiquement le param√®tre `company` et affiche/cache la section matching.

### G√©n√©ration

```bash
# Style synthwave
task site:generate:synthwave

# Style √©l√©gant classique
task site:generate

# Ouvrir dans le navigateur
task site:open

# Servir localement (pour tester avec ?company=X)
cd apps/static-site
npx serve output -p 3000
open http://localhost:3000?company=Hones
```

### Images et CV

**Pour l'image workflow:**
- Cr√©ez votre diagramme sur Excalidraw/Figma
- Placez dans `assets/images/workflow.png`
- Ou utilisez un placeholder: `placehold.co`

**Pour le CV (iframe):**
- ‚úÖ **Recommand√©:** GitHub Pages (`username.github.io`)
- ‚úÖ Google Drive (mode preview)
- ‚úÖ Notion page publique
- ‚ùå √âviter: GitHub.com direct, LinkedIn (bloquent iframe)

Voir `apps/static-site/IMAGES-CV.md` pour le guide complet.

## Workflow API - G√©n√©ration Compl√®te de Candidature

### Vue d'ensemble

Le Workflow API permet de g√©n√©rer automatiquement tous les √©l√©ments d'une candidature professionnelle :
1. **Site de pr√©sentation** (HTML + PDF)
2. **QR code** pointant vers le site
3. **Lettre de motivation PDF** avec QR code int√©gr√©
4. **H√©bergement self-hosted** du site HTML

### Architecture

**Backend-Orchestrated Workflow:**
- Une seule requ√™te API pour tout le workflow
- Traitement asynchrone avec progress tracking
- Polling frontend pour r√©cup√©rer le statut
- Stockage persistant en PostgreSQL

**Endpoints:**
```
POST   /api/workflow/application        # Cr√©er un workflow
GET    /api/workflow/application/:id/status  # R√©cup√©rer le statut
GET    /hosted-sites/:siteName          # Servir le site HTML
```

### Utilisation

#### 1. Cr√©er un Workflow

**Request:**
```bash
curl -X POST http://localhost:3001/api/workflow/application \
  -H "Content-Type: application/json" \
  -d '{
    "personalInfo": {
      "name": "Jean Dupont",
      "email": "jean.dupont@example.com",
      "phone": "+33 6 12 34 56 78",
      "linkedin": "https://linkedin.com/in/jeandupont",
      "github": "https://github.com/jeandupont"
    },
    "companyInfo": {
      "name": "Entreprise Cible",
      "position": "D√©veloppeur Full Stack Senior",
      "jobId": "uuid-optional"
    },
    "letterContent": {
      "template": "elegant",
      "introduction": "Passionn√© par le d√©veloppement...",
      "motivation": "Ce qui m'\''a particuli√®rement interpell√©...",
      "closing": "Je serais ravi d'\''√©changer..."
    },
    "siteContent": {
      "template": "elegant",
      "title": "Jean Dupont",
      "subtitle": "D√©veloppeur Full Stack Senior",
      "about": "10 ans d'\''exp√©rience...",
      "matchingPoints": [
        {
          "icon": "üöÄ",
          "title": "Innovation",
          "description": "Expertise en technologies modernes"
        }
      ],
      "stats": [
        { "number": "10+", "label": "Ann√©es d'\''exp√©rience" },
        { "number": "50+", "label": "Projets livr√©s" }
      ]
    },
    "options": {
      "qrStyle": "elegant"
    }
  }'
```

**Response:**
```json
{
  "success": true,
  "workflowId": "uuid-workflow-id",
  "status": "processing",
  "progress": 0
}
```

#### 2. Polling du Statut

**Request:**
```bash
curl http://localhost:3001/api/workflow/application/:id/status
```

**Response (en cours):**
```json
{
  "success": true,
  "workflowId": "uuid-workflow-id",
  "status": "processing",
  "progress": 70
}
```

**Response (termin√©):**
```json
{
  "success": true,
  "workflowId": "uuid-workflow-id",
  "status": "completed",
  "progress": 100,
  "files": {
    "siteHtml": "/hosted-sites/site-1234567890",
    "sitePdf": "/api/generators/site/download/site-1234567890.pdf",
    "qrImage": "/api/generators/qr/download/qr-1234567890.png",
    "letterPdf": "/api/generators/letter/download/letter-1234567890.pdf"
  }
}
```

#### 3. Acc√©der aux Fichiers

**Site HTML (self-hosted):**
```bash
# Ouvrir dans le navigateur
open http://localhost:3001/hosted-sites/site-1234567890
```

**T√©l√©charger les PDFs:**
```bash
# Site PDF
curl -O http://localhost:3001/api/generators/site/download/site-1234567890.pdf

# Lettre PDF
curl -O http://localhost:3001/api/generators/letter/download/letter-1234567890.pdf

# QR Code PNG
curl -O http://localhost:3001/api/generators/qr/download/qr-1234567890.png
```

### √âtapes du Workflow

Le workflow s'ex√©cute en 6 √©tapes avec progress tracking :

1. **G√©n√©ration site HTML** (0% ‚Üí 20%)
   - Template hydrat√© avec donn√©es personnalis√©es
   - Sauvegarde dans `apps/static-site/output/` et `hosted-sites/`

2. **G√©n√©ration site PDF** (20% ‚Üí 40%)
   - Conversion HTML ‚Üí PDF avec Puppeteer
   - Format A4, print-optimized

3. **Cr√©ation URL site** (40% ‚Üí 50%)
   - URL self-hosted : `/hosted-sites/site-{timestamp}`
   - Accessible imm√©diatement via backend

4. **G√©n√©ration QR code** (50% ‚Üí 70%)
   - QR pointant vers le site self-hosted
   - Style √©l√©gant avec couleurs personnalis√©es
   - Data URL (base64) pour int√©gration

5. **G√©n√©ration lettre avec QR** (70% ‚Üí 90%)
   - QR code int√©gr√© directement dans le PDF
   - Template √©l√©gant avec polices premium
   - Mise en page professionnelle

6. **Finalisation** (90% ‚Üí 100%)
   - Sauvegarde r√©sultats en DB
   - Status ‚Üí "completed"
   - Fichiers pr√™ts au t√©l√©chargement

### Templates Disponibles

**Letter Templates:**
- `elegant`: Template √©l√©gant de No√´l (polices manuscrites, couleurs raffin√©es)
- `standard`: Template professionnel classique
- `christmas`: Alias pour elegant

**Site Templates:**
- `elegant`: Design classique et professionnel
- `synthwave`: Style r√©tro-futuriste avec n√©ons

### Options de Personnalisation

**QR Style:**
- `elegant`: Couleurs assorties au template (#2c3e50 / #fdfbf7)
- `standard`: Noir et blanc classique

**Letter Data Fields:**
- `sender-name`, `sender-email`, `sender-phone`
- `company-name`, `position`
- `intro-paragraph`, `matching-description`, `closing-paragraph`
- `qr-code`: Auto-g√©n√©r√© par le workflow
- `Date`: Auto-g√©n√©r√© (date actuelle)

**Site Data Fields:**
- `title`, `subtitle`, `about`
- `workflow-steps`: Array d'√©tapes avec titre et description
- `matching-points`: Array de points avec ic√¥ne, titre, description
- `stats`: Array de statistiques avec nombre et label
- `footer-links`: Array de liens avec URL et texte

### Gestion des Erreurs

**Status "failed":**
```json
{
  "success": false,
  "workflowId": "uuid",
  "status": "failed",
  "progress": 40,
  "error": "Message d'erreur d√©taill√©"
}
```

**Erreurs communes:**
- Template inexistant
- Donn√©es JSON invalides
- Puppeteer timeout (images lourdes)
- Permissions fichiers (hosted-sites/)

### Base de Donn√©es

**Table `workflows`:**
- `id`: UUID
- `status`: 'pending' | 'processing' | 'completed' | 'failed'
- `progress`: 0-100
- `currentStep`: Nom de l'√©tape en cours
- `inputData`: JSON complet de la requ√™te
- `result`: Chemins des fichiers g√©n√©r√©s + URL site
- `error`: Message d'erreur si failed
- `relatedJobId`: FK vers job scrap√© (optionnel)
- `createdAt`, `updatedAt`: Timestamps

### Configuration

**Variables d'environnement (.env):**
```env
BASE_URL=http://localhost:3001
HOSTED_SITES_PATH=../hosted-sites
```

**Production:**
```env
BASE_URL=https://api.example.com
HOSTED_SITES_PATH=/var/www/hosted-sites
```

### Frontend Integration (√Ä venir - Sprint 2)

**Wizard 6 √©tapes:**
1. Informations personnelles
2. Informations entreprise
3. Design du site
4. Contenu lettre
5. Pr√©visualisation
6. R√©sultat & t√©l√©chargements

**Int√©grations:**
- Bouton sur chaque job scrap√© : "Postuler avec g√©n√©rateur"
- Page standalone : "Cr√©er une candidature"

### Self-Hosted Sites

**Fonctionnement:**
- Sites servis directement par le backend NestJS
- Endpoint d√©di√© : `GET /hosted-sites/:siteName`
- Fichiers HTML stock√©s dans `hosted-sites/`
- Pas de d√©ploiement externe requis (Netlify/Vercel)

**Avantages:**
- H√©bergement instantan√© (pas de build/deploy)
- URLs imm√©diates pour QR codes
- Contr√¥le total sur les fichiers
- Pas de co√ªts externes

**Limitations:**
- Requiert backend running pour acc√®s
- Pas de CDN (pour MVP)
- Scalabilit√© limit√©e vs cloud hosting

### Exemple Complet

```bash
# 1. Cr√©er le workflow
WORKFLOW_ID=$(curl -s -X POST http://localhost:3001/api/workflow/application \
  -H "Content-Type: application/json" \
  -d @workflow-data.json | jq -r '.workflowId')

echo "Workflow cr√©√©: $WORKFLOW_ID"

# 2. Polling du statut (toutes les 2 secondes)
while true; do
  STATUS=$(curl -s http://localhost:3001/api/workflow/application/$WORKFLOW_ID/status)
  CURRENT_STATUS=$(echo $STATUS | jq -r '.status')
  PROGRESS=$(echo $STATUS | jq -r '.progress')

  echo "Status: $CURRENT_STATUS - Progress: $PROGRESS%"

  if [ "$CURRENT_STATUS" = "completed" ] || [ "$CURRENT_STATUS" = "failed" ]; then
    break
  fi

  sleep 2
done

# 3. R√©cup√©rer les URLs
if [ "$CURRENT_STATUS" = "completed" ]; then
  echo $STATUS | jq '.files'

  # Ouvrir le site
  SITE_URL=$(echo $STATUS | jq -r '.files.siteHtml')
  open "http://localhost:3001$SITE_URL"
fi
```

## Derni√®re Mise √† Jour

Date: 2025-12-09
Version: 1.8.0
Status: Workflow API complet impl√©ment√© - Sprint 1 termin√© (WorkflowModule, HostingModule, SiteService.generateHTMLFile, LetterService.generateLetterWithQr, self-hosted sites). Backend fonctionnel avec orchestration compl√®te Site ‚Üí QR ‚Üí Letter. Frontend wizard √† impl√©menter (Sprint 2).
