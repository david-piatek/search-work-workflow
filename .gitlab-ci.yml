# GitLab CI/CD Configuration
# GitHub → Tests, Lint, SonarQube
# GitLab → Docker Build + Deploy (ArgoCD)

stages:
  - build
  - deploy

variables:
  DOCKER_REGISTRY: registry.gitlab.com/dav.piatek/job-search-workflow
  ARGOCD_SERVER: argocd.draw-me-the-moon.fr
  ARGOCD_APP_NAME: job-search
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_DRIVER: overlay2

# Docker build with Bake
docker-build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  only:
    - main
    - develop
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker images with Bake..."
    - export TAG=$CI_COMMIT_REF_NAME
    - export COMMIT_SHA=$CI_COMMIT_SHORT_SHA
    - export BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
    - export REGISTRY=$DOCKER_REGISTRY
    - export BUILDX_BAKE_ENTITLEMENTS_FS=0
    - docker context create builder-context || true
    - docker buildx create --use --name builder builder-context || docker buildx use builder
    - docker buildx bake -f cloud/docker/docker-bake.hcl prod --push

# Deploy to Kubernetes via ArgoCD
deploy:
  stage: deploy
  image: argoproj/argocd:latest
  only:
    - main
  needs:
    - docker-build
  script:
    - echo "Triggering ArgoCD deployment"
    - |
      argocd login $ARGOCD_SERVER \
        --username $ARGOCD_USERNAME \
        --password $ARGOCD_PASSWORD \
        --grpc-web
    - |
      argocd app sync $ARGOCD_APP_NAME \
        --prune \
        --timeout 600
    - argocd app wait $ARGOCD_APP_NAME --timeout 600
    - echo "Deployment complete!"
  environment:
    name: production
    url: https://job-search.draw-me-the-moon.fr
  allow_failure: true
