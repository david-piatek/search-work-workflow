stages:
  - build
  - deploy
  - verify

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  BACKEND_IMAGE: $CI_REGISTRY_IMAGE/backend
  FRONTEND_IMAGE: $CI_REGISTRY_IMAGE/frontend

.docker-login: &docker-login
  - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY

build-backend:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - *docker-login
  script:
    - docker build -f cloud/docker/Dockerfile.backend-simple -t $BACKEND_IMAGE:$CI_COMMIT_SHA -t $BACKEND_IMAGE:latest .
    - docker push $BACKEND_IMAGE:$CI_COMMIT_SHA
    - docker push $BACKEND_IMAGE:latest
  only:
    - main
    - develop
  tags:
    - docker

build-frontend:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - *docker-login
  script:
    - docker build -f cloud/docker/Dockerfile.frontend-simple -t $FRONTEND_IMAGE:$CI_COMMIT_SHA -t $FRONTEND_IMAGE:latest .
    - docker push $FRONTEND_IMAGE:$CI_COMMIT_SHA
    - docker push $FRONTEND_IMAGE:latest
  only:
    - main
    - develop
  tags:
    - docker

deploy-staging:
  stage: deploy
  image: alpine/helm:latest
  before_script:
    - apk add --no-cache curl
    - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    - chmod +x kubectl
    - mv kubectl /usr/local/bin/
    - mkdir -p ~/.kube
    - echo "$KUBE_CONFIG_STAGING" | base64 -d > ~/.kube/config
  script:
    - |
      helm upgrade --install job-scraper-staging ./cloud/helm/job-scraper-app \
        --namespace job-scraper-staging \
        --create-namespace \
        --set image.backend.repository=$BACKEND_IMAGE \
        --set image.backend.tag=$CI_COMMIT_SHA \
        --set image.frontend.repository=$FRONTEND_IMAGE \
        --set image.frontend.tag=$CI_COMMIT_SHA \
        --set environment=staging \
        --wait \
        --timeout 5m
  environment:
    name: staging
    url: https://staging.job-scraper.example.com
  only:
    - develop
  tags:
    - kubernetes

deploy-production:
  stage: deploy
  image: alpine/helm:latest
  before_script:
    - apk add --no-cache curl
    - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    - chmod +x kubectl
    - mv kubectl /usr/local/bin/
    - mkdir -p ~/.kube
    - echo "$KUBE_CONFIG_PROD" | base64 -d > ~/.kube/config
  script:
    - |
      helm upgrade --install job-scraper ./cloud/helm/job-scraper-app \
        --namespace job-scraper \
        --create-namespace \
        --set image.backend.repository=$BACKEND_IMAGE \
        --set image.backend.tag=$CI_COMMIT_SHA \
        --set image.frontend.repository=$FRONTEND_IMAGE \
        --set image.frontend.tag=$CI_COMMIT_SHA \
        --set environment=production \
        --wait \
        --timeout 10m
  environment:
    name: production
    url: https://job-scraper.example.com
  when: manual
  only:
    - main
  tags:
    - kubernetes

verify-deployment:
  stage: verify
  image: curlimages/curl:latest
  script:
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ]; then
        ENDPOINT="https://job-scraper.example.com/api/health"
      else
        ENDPOINT="https://staging.job-scraper.example.com/api/health"
      fi
    - echo "Checking health endpoint: $ENDPOINT"
    - sleep 30
    - |
      for i in {1..5}; do
        if curl -f -s $ENDPOINT; then
          echo "Health check passed!"
          exit 0
        fi
        echo "Attempt $i failed, retrying..."
        sleep 10
      done
      echo "Health check failed after 5 attempts"
      exit 1
  needs:
    - deploy-staging
  only:
    - develop
  tags:
    - docker

verify-production:
  stage: verify
  image: curlimages/curl:latest
  script:
    - ENDPOINT="https://job-scraper.example.com/api/health"
    - echo "Checking production health endpoint: $ENDPOINT"
    - sleep 30
    - |
      for i in {1..5}; do
        if curl -f -s $ENDPOINT; then
          echo "Production health check passed!"
          exit 0
        fi
        echo "Attempt $i failed, retrying..."
        sleep 10
      done
      echo "Production health check failed after 5 attempts"
      exit 1
  needs:
    - deploy-production
  when: on_success
  only:
    - main
  tags:
    - docker
